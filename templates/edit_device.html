{% extends "base.html" %}

{% block title %}デバイス編集{% endblock %}
{% block container_width %}800px{% endblock %}
{% block heading %}デバイスを編集{% endblock %}

{% block content %}
        <form method="POST">
            <div>
                <label for="name">名前:</label>
                <input type="text" id="name" name="name" required value="{{ device.name }}">
            </div>
            <div>
                <label for="local_ip">ローカルIPアドレス:</label>
                <input type="text" id="local_ip" name="local_ip" pattern="^([0-9]{1,3}\.){3}[0-9]{1,3}$|^$" title="有効なIPv4アドレスを入力してください (例: 192.168.1.1)" value="{{ device.local_ip if device.local_ip else '' }}">
            </div>
            <div>
                <label for="tailscale_ip">Tailscale IPアドレス:</label>
                <input type="text" id="tailscale_ip" name="tailscale_ip" pattern="^([0-9]{1,3}\.){3}[0-9]{1,3}$|^$" title="有効なIPv4アドレスを入力してください (例: 100.100.100.100)" value="{{ device.tailscale_ip if device.tailscale_ip else '' }}">
            </div>

            <h2>サービス一覧</h2>
            <div id="services-container">
                {% if device.services %}
                    {% for service in device.services %}
                    <div class="service-entry-row">
                        <input type="text" name="service_name[]" placeholder="サービス名" value="{{ service.name }}" required>
                        <input type="number" name="service_port[]" placeholder="ポート (空欄可)" min="1" max="65535" value="{{ service.port if service.port is not none else '' }}">
                        <button type="button" class="remove-service-btn">削除</button>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="service-entry-row">
                        <input type="text" name="service_name[]" placeholder="サービス名 (例: Web)" required>
                        <input type="number" name="service_port[]" placeholder="ポート (空欄可)" min="1" max="65535">
                        <button type="button" class="remove-service-btn" style="display:none;">削除</button>
                    </div>
                {% endif %}
            </div>
            <button type="button" id="add-service-btn" class="add-service-btn">サービスを追加</button>

            <button type="submit">更新</button>
        </form>
        <a href="{{ url_for('index') }}" class="back-button">戻る</a>
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const servicesContainer = document.getElementById('services-container');
            const addServiceBtn = document.getElementById('add-service-btn');

            function updateRemoveButtons() {
                const removeButtons = servicesContainer.querySelectorAll('.remove-service-btn');
                if (removeButtons.length <= 1) {
                    removeButtons.forEach(btn => btn.style.display = 'none');
                } else {
                    removeButtons.forEach(btn => btn.style.display = 'inline-block');
                }
            }

            addServiceBtn.addEventListener('click', function() {
                const newServiceRow = document.createElement('div');
                newServiceRow.classList.add('service-entry-row');
                newServiceRow.innerHTML = `
                    <input type="text" name="service_name[]" placeholder="サービス名" required>
                    <input type="number" name="service_port[]" placeholder="ポート (空欄可)" min="1" max="65535">
                    <button type="button" class="remove-service-btn">削除</button>
                `;
                servicesContainer.appendChild(newServiceRow);
                updateRemoveButtons();
            });

            servicesContainer.addEventListener('click', function(event) {
                if (event.target.classList.contains('remove-service-btn')) {
                    if (servicesContainer.children.length > 1) {
                        event.target.closest('.service-entry-row').remove();
                        updateRemoveButtons();
                    } else {
                        alert('少なくとも一つのサービスは入力してください。');
                    }
                }
            });

            updateRemoveButtons();
        });
    </script>
{% endblock %}
